<html>
<head>
<title>Broadcast Service</title>
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"/>
<style type="text/css">
  /* Space out content a bit */
  body {
    padding-top: 20px;
    padding-bottom: 20px;
  }
</style>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<script>
var app = angular.module('broadcastService', []);
app.factory('socket', ['$rootScope', function ($rootScope) {
  var socket = io.connect();

  return {
    on: function (eventName, callback) {
      function wrapper() {
        var args = arguments;
        $rootScope.$apply(function () {
          callback.apply(socket, args);
        });
      }

      socket.on(eventName, wrapper);

      return function () {
        socket.removeListener(eventName, wrapper);
      };
    },

    emit: function (eventName, data, callback) {
      socket.emit(eventName, data, function () {
        var args = arguments;
        $rootScope.$apply(function () {
          if(callback) {
            callback.apply(socket, args);
          }
        });
      });
    }
  };
}]);
app.controller('broadcastServiceController', ['$scope', 'socket', function($scope, socket) {
    $scope.pesanDiterima = [];
    $scope.content = "";
    $scope.source = "";
    $scope.destination = "";
    $scope.sendMessage = function() {
        socket.emit('sendMessage', {source: $scope.source, content: $scope.content, destination: $scope.destination}, function(err) {
            if(err) {
                alert('Some error may happened. Try again.')
            } else {
                alert('Your message was processed');
                $scope.content = "";
                $scope.destination = "";
            }
        });

    }

    socket.on('retrieveMessage', function(data) {
        $scope.pesanDiterima.push(data);
    });
    socket.emit('getAllMessage', {}, function(data) {
        $scope.pesanDiterima = data;
    });
}])
</script>
</head>
<body ng-app="broadcastService">
<div ng-controller="broadcastServiceController">
<div class="container">
  <div class="header">
    <h3 class="text-muted">Broadcast Service</h3>
  </div>

  <div class="row">
    <div class="col-lg-4">
        <div class="form-group">
            <label class="control-label">Your Name</label>
            <div class="controls"><input type="text" class="form-control" ng-model="source" /></div>
        </div>
        <div class="form-group">
            <label class="control-label">Content</label>
            <div class="controls"><input type="text" class="form-control" ng-model="content" /></div>
        </div>
        <div class="form-group">
            <label class="control-label">Destination IP</label>
            <div class="controls"><input type="text" class="form-control" ng-model="destination" /></div>
        </div>
        <div class="form-group">
            <button ng-click="sendMessage()" class="btn btn-primary">Send</button>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Received Messages</h3>
            </div>
            <div class="panel-body">
                <h4 ng-repeat="item in pesanDiterima"><strong>{{item.source}}: </strong>{{item.content}}</h4>
            </div>
        </div>
    </div>
  </div>

  <div class="footer">
    <p>&copy; Suli dan Wira 2014</p>
  </div>

</div> <!-- /container -->
</div>
</body>
</html>
